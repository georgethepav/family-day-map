<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Family Day Animated Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      height: 100vh;
      width: 100vw;
    }

    /* Bottom timeline + legend */
    #controls {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      padding: 8px 16px;
      font-family: sans-serif;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.15);
    }
    #controls-inner {
      max-width: 900px;
      margin: 0 auto;
    }
    #slider-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 6px;
    }
    #time-display {
      font-weight: bold;
      font-size: 14px;
      white-space: nowrap;
    }
    #time-slider {
      width: 100%;
    }
    #legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
      font-size: 13px;
      line-height: 1.4;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .swatch {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 1px solid #555;
    }
    .alex { background: pink; }
    .granny { background: red; }
    .billy { background: lightblue; }
    .grandad { background: darkblue; }
    .estelle { background: purple; }
    .george { background: green; }

    /* Top-right locations legend */
    #places-legend {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.9);
      padding: 8px 10px;
      border-radius: 8px;
      font-family: sans-serif;
      font-size: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      max-width: 260px;
    }
    #places-legend-title {
      font-weight: bold;
      margin-bottom: 4px;
    }
    .place-item {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      margin-bottom: 2px;
    }
    .place-pin {
      font-size: 12px;
      line-height: 1.2;
    }
  </style>
</head>
<body>

<div id="places-legend">
  <div id="places-legend-title">Locations</div>
  <div class="place-item"><span class="place-pin">üìç</span><span>Home ‚Äì 21 Cannon St</span></div>
  <div class="place-item"><span class="place-pin">üìç</span><span>Ballet ‚Äì St Giles, West Bridgford</span></div>
  <div class="place-item"><span class="place-pin">üìç</span><span>Football ‚Äì Digby Avenue, Mapperley</span></div>
  <div class="place-item"><span class="place-pin">üìç</span><span>Swimming ‚Äì Arnold Leisure Centre</span></div>
  <div class="place-item"><span class="place-pin">üìç</span><span>Paviors ‚Äì Burntstump Hill, Arnold</span></div>
  <div class="place-item"><span class="place-pin">üìç</span><span>Granny &amp; Grandad ‚Äì Burton Joyce</span></div>
  <div class="place-item"><span class="place-pin">üìç</span><span>Party ‚Äì Gedling Road, Woodthorpe</span></div>
  <div class="place-item"><span class="place-pin">üìç</span><span>Estelle‚Äôs Work ‚Äì Broxtowe Police Station</span></div>
</div>

<div id="controls">
  <div id="controls-inner">
    <div id="slider-row">
      <div id="time-display">Time: 08:30</div>
      <input type="range" id="time-slider" min="510" max="990" value="510" step="1" />
    </div>
    <div id="legend">
      <div class="legend-item"><span class="swatch alex"></span> Alex (pink)</div>
      <div class="legend-item"><span class="swatch estelle"></span> Estelle (purple)</div>
      <div class="legend-item"><span class="swatch billy"></span> Billy (light blue)</div>
      <div class="legend-item"><span class="swatch george"></span> George (green)</div>
      <div class="legend-item"><span class="swatch granny"></span> Granny (red)</div>
      <div class="legend-item"><span class="swatch grandad"></span> Grandad (dark blue)</div>
    </div>
  </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// --- Helper: time to minutes ---
function toMinutes(t) {
  const [h, m] = t.split(":").map(Number);
  return h * 60 + m;
}

// --- Locations (approx coords) ---
const locations = {
  house:   [52.954205, -1.146630], // 21 Cannon St
  ballet:  [52.930870, -1.129820], // St Giles, West Bridgford
  football:[52.988680, -1.111820], // Digby Ave
  swimming:[53.000690, -1.133000], // Arnold Leisure
  paviors: [53.023270, -1.142700], // Paviors RFC
  granny:  [52.986890, -1.032500], // Burton Joyce
  party:   [52.993650, -1.132550], // Gedling Rd, Woodthorpe
  work:    [52.979500, -1.214000]  // Broxtowe Police Station (approx)
};

// --- Map setup ---
const map = L.map('map').setView([52.97, -1.14], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

// Add map pins with labels (names on the map)
const placeLabels = {
  house:  "Home",
  ballet: "Ballet",
  football: "Football",
  swimming: "Swimming",
  paviors: "Paviors",
  granny: "Granny & Grandad",
  party: "Party",
  work: "Estelle's Work"
};

for (const key in locations) {
  L.marker(locations[key])
    .addTo(map)
    .bindTooltip(placeLabels[key], {
      permanent: true,
      direction: 'top',
      offset: [0, -10]
    });
}

// --- Person colours ---
const colours = {
  alex: 'pink',
  granny: 'red',
  billy: 'lightblue',
  grandad: 'darkblue',
  estelle: 'purple',
  george: 'green'
};

// --- Starting locations ---
const defaultLocation = {
  alex: 'house',
  estelle: 'house',
  billy: 'house',
  george: 'house',
  granny: 'granny',
  grandad: 'granny'
};

// --- Non-overlap offsets so blobs are side-by-side ---
const offsets = {
  alex:    [ 0.0010,  0.0000],
  estelle: [-0.0010,  0.0000],
  billy:   [ 0.0000,  0.0010],
  george:  [ 0.0000, -0.0010],
  granny:  [ 0.0007,  0.0007],
  grandad: [-0.0007, -0.0007]
};

function applyOffset(latlng, person) {
  const off = offsets[person] || [0, 0];
  return [latlng[0] + off[0], latlng[1] + off[1]];
}

// Helper to build segments
function seg(start, end, from, to) {
  return {
    start: toMinutes(start),
    end: toMinutes(end),
    from,
    to
  };
}

// --- Schedules per person based on your itinerary ---

const schedules = {
  estelle: [
    seg('08:30','09:00','house','ballet'),
    seg('09:45','10:25','ballet','swimming'),
    seg('11:30','11:45','swimming','house'),
    seg('13:00','13:20','house','granny'),
    seg('13:30','14:00','granny','party'),
    seg('14:05','14:30','party','work') // to Broxtowe Police Station
  ],
  alex: [
    seg('08:30','09:00','house','ballet'),
    seg('09:45','10:25','ballet','swimming'),
    seg('11:30','11:45','swimming','house'),
    seg('13:00','13:20','house','granny'),
    // Stays with Granny, then:
    seg('13:45','14:15','granny','paviors'),
    seg('15:30','16:00','paviors','party'),
    seg('16:00','16:30','party','paviors')
  ],
  billy: [
    seg('08:45','09:00','house','football'),
    seg('10:00','10:10','football','house'),
    seg('13:00','13:20','house','granny'),
    seg('13:30','14:00','granny','party'),
    seg('16:00','16:30','party','paviors')
  ],
  george: [
    seg('08:45','09:00','house','football'),
    seg('10:00','10:10','football','house'),
    seg('11:55','12:15','house','granny'),
    seg('12:15','12:45','granny','paviors')
  ],
  grandad: [
    seg('12:15','12:45','granny','paviors')
  ],
  granny: [
    seg('13:45','14:15','granny','paviors'),
    seg('15:30','16:00','paviors','party'),
    seg('16:00','16:30','party','paviors')
  ]
};

// --- Create person markers ---
const markers = {};
for (const person in colours) {
  const startLocKey = defaultLocation[person];
  const startLatLng = locations[startLocKey];
  markers[person] = L.circleMarker(applyOffset(startLatLng, person), {
    radius: 8,
    color: colours[person],
    fillColor: colours[person],
    fillOpacity: 1
  })
  .addTo(map)
  .bindTooltip(person.charAt(0).toUpperCase() + person.slice(1), {
    permanent: false,
    direction: 'right',
    offset: [8, 0]
  });
}

// --- Time controls ---
const timeSlider = document.getElementById('time-slider');
const timeDisplay = document.getElementById('time-display');
const dayStart = Number(timeSlider.min); // 08:30
const dayEnd = Number(timeSlider.max);   // 16:30

function formatTime(minutes) {
  const h = Math.floor(minutes / 60);
  const m = minutes % 60;
  const hh = h.toString().padStart(2,'0');
  const mm = m.toString().padStart(2,'0');
  return `${hh}:${mm}`;
}

// Get position for a person at time t
function getPositionFor(person, t) {
  const segs = schedules[person] || [];
  if (segs.length === 0) {
    return applyOffset(locations[defaultLocation[person]], person);
  }

  // before first movement
  if (t < segs[0].start) {
    return applyOffset(locations[defaultLocation[person]], person);
  }

  // after last movement
  if (t > segs[segs.length - 1].end) {
    return applyOffset(locations[segs[segs.length - 1].to], person);
  }

  // during a journey
  for (const s of segs) {
    if (t >= s.start && t <= s.end) {
      const from = locations[s.from];
      const to   = locations[s.to];
      const ratio = (t - s.start) / (s.end - s.start || 1);
      const baseLat = from[0] + (to[0] - from[0]) * ratio;
      const baseLng = from[1] + (to[1] - from[1]) * ratio;
      return applyOffset([baseLat, baseLng], person);
    }
  }

  // between journeys, stay at last 'to'
  for (let i = 0; i < segs.length - 1; i++) {
    if (t > segs[i].end && t < segs[i+1].start) {
      return applyOffset(locations[segs[i].to], person);
    }
  }

  return applyOffset(locations[defaultLocation[person]], person);
}

function updateAllPositions(t) {
  for (const person in markers) {
    const pos = getPositionFor(person, t);
    markers[person].setLatLng(pos);
  }
  timeDisplay.textContent = 'Time: ' + formatTime(t);
}

// initial position
updateAllPositions(dayStart);

// Slider interaction + autoplay
let userIsDragging = false;
timeSlider.addEventListener('input', () => {
  const t = Number(timeSlider.value);
  userIsDragging = true;
  updateAllPositions(t);
});
timeSlider.addEventListener('change', () => {
  userIsDragging = false;
});

let currentTime = dayStart;
const stepMinutes = 1;
const stepIntervalMs = 300;

const autoplay = setInterval(() => {
  if (userIsDragging) return;
  currentTime += stepMinutes;
  if (currentTime > dayEnd) {
    clearInterval(autoplay);
    return;
  }
  timeSlider.value = currentTime.toString();
  updateAllPositions(currentTime);
}, stepIntervalMs);
</script>
</body>
</html>
